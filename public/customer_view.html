<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gọi món</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white shadow-sm sticky top-0 z-10 p-4">
        <div class="max-w-md mx-auto">
            <h1 class="text-2xl font-bold text-gray-800">The Coffee House</h1>
            <p class="text-gray-500">Bàn <span id="table-number" class="font-semibold text-indigo-600"></span></p>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-24">
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Danh mục</h2>
            <div id="category-container" class="flex space-x-3 overflow-x-auto pb-2">
                </div>
        </div>

        <div id="menu-container" class="space-y-4">
            <p>Đang tải thực đơn...</p>
        </div>
    </main>

    <div id="cart-button-container" class="fixed bottom-4 right-4 z-20">
        <button onclick="toggleCartModal(true)" class="bg-indigo-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
        </button>
    </div>
    
    <div id="cart-modal" class="hidden fixed inset-0 z-30 fade-in">
        <div class="absolute inset-0 modal-bg" onclick="toggleCartModal(false)"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-xl p-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Giỏ hàng của bạn</h2>
                <button onclick="toggleCartModal(false)" class="text-gray-500 text-2xl font-bold">&times;</button>
            </div>
            <div id="cart-items-container" class="overflow-y-auto flex-grow"></div>
            <div class="mt-4 border-t pt-4">
                <div class="flex justify-between items-center text-lg font-semibold">
                    <span>Tổng cộng:</span>
                    <span id="cart-total">0đ</span>
                </div>
                 <div class="mt-4">
                    <label for="note" class="block text-sm font-medium text-gray-700">Ghi chú</label>
                    <textarea id="note" name="note" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ví dụ: Ít ngọt, không đá..."></textarea>
                </div>
                <button onclick="submitOrder()" class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-indigo-700">Gửi đơn hàng</button>
            </div>
        </div>
    </div>

    <div id="options-modal" class="hidden fixed inset-0 z-40 fade-in">
        <div class="absolute inset-0 modal-bg" onclick="toggleOptionsModal(false)"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-xl p-4 flex flex-col">
            <h2 id="options-modal-title" class="text-xl font-bold mb-4">Tùy chỉnh món</h2>
            <div id="options-modal-content" class="space-y-4"></div>
            <button id="add-to-cart-btn" class="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-indigo-700">Thêm vào giỏ</button>
        </div>
    </div>
    
    <div id="success-notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md fade-in">
        Đặt hàng thành công!
    </div>

<script>
    const API_URL = 'https://qr-order-system-l6jw.onrender.com/'; // Thay bằng URL thật của bạn
    const urlParams = new URLSearchParams(window.location.search);
    const tableNumber = urlParams.get('table');

    let menu = [];
    let cart = [];
    let currentProduct = null;

    const menuContainer = document.getElementById('menu-container');
    const categoryContainer = document.getElementById('category-container');
    const cartCount = document.getElementById('cart-count');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotal = document.getElementById('cart-total');

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    function renderCategories() {
        const categories = ['Tất cả', ...new Set(menu.map(item => item.category))];
        categoryContainer.innerHTML = '';
        categories.forEach((category, index) => {
            const isFirst = index === 0;
            const button = document.createElement('button');
            button.className = `category-btn px-4 py-2 rounded-full text-sm font-medium border whitespace-nowrap ${isFirst ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700'}`;
            button.dataset.category = category;
            button.textContent = category;
            button.onclick = (e) => {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700');
                });
                e.target.classList.add('bg-indigo-600', 'text-white');
                renderMenu(category);
            };
            categoryContainer.appendChild(button);
        });
    }
    
    function renderMenu(category = 'Tất cả') {
        menuContainer.innerHTML = '';
        const filteredMenu = category === 'Tất cả' ? menu : menu.filter(item => item.category === category);
        
        filteredMenu.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-sm p-3 flex items-center space-x-4 fade-in';
            div.innerHTML = `
                <img src="${item.image_url || 'https://placehold.co/100x100'}" alt="${item.name}" class="w-20 h-20 rounded-md object-cover">
                <div class="flex-grow">
                    <h3 class="font-semibold text-gray-800">${item.name}</h3>
                    <p class="text-sm text-gray-500">${formatCurrency(item.price)}</p>
                </div>
                <button onclick="handleItemClick(${item.id})" class="bg-indigo-100 text-indigo-600 rounded-full w-10 h-10 flex items-center justify-center font-bold text-2xl">+</button>
            `;
            menuContainer.appendChild(div);
        });
    }

    function handleItemClick(itemId) {
        currentProduct = menu.find(p => p.id === itemId);
        if (currentProduct.options && Object.keys(currentProduct.options).length > 0) {
            populateOptionsModal(currentProduct);
            toggleOptionsModal(true);
        } else {
            addToCart(currentProduct, {});
        }
    }

    function populateOptionsModal(product) {
        const modalTitle = document.getElementById('options-modal-title');
        const modalContent = document.getElementById('options-modal-content');
        modalTitle.textContent = `Tùy chỉnh: ${product.name}`;
        modalContent.innerHTML = '';

        Object.entries(product.options).forEach(([optionName, values]) => {
            const optionGroup = document.createElement('div');
            optionGroup.innerHTML = `<h4 class="font-medium mb-2">${optionName}</h4>`;
            const radioContainer = document.createElement('div');
            radioContainer.className = 'flex flex-wrap gap-2';
            
            values.forEach((value, index) => {
                const checked = index === 0 ? 'checked' : '';
                radioContainer.innerHTML += `
                    <div>
                        <input type="radio" id="${optionName}-${value}" name="${optionName}" value="${value}" class="hidden peer" ${checked}>
                        <label for="${optionName}-${value}" class="px-3 py-1.5 border rounded-full text-sm cursor-pointer peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600">${value}</label>
                    </div>
                `;
            });
            optionGroup.appendChild(radioContainer);
            modalContent.appendChild(optionGroup);
        });

        document.getElementById('add-to-cart-btn').onclick = () => {
            const selectedOptions = {};
            Object.keys(product.options).forEach(optionName => {
                const selected = document.querySelector(`input[name="${optionName}"]:checked`);
                if (selected) {
                    selectedOptions[optionName] = selected.value;
                }
            });
            addToCart(product, selectedOptions);
            toggleOptionsModal(false);
        };
    }

    function addToCart(product, options) {
        const existingItem = cart.find(item => item.id === product.id && JSON.stringify(item.options) === JSON.stringify(options));

        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...product, options, quantity: 1, cartItemId: Date.now() });
        }
        updateCart();
    }
    
    function updateCart() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCount.textContent = totalItems;
        cartCount.classList.toggle('hidden', totalItems === 0);

        cartItemsContainer.innerHTML = '';
        let total = 0;
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Giỏ hàng của bạn đang trống.</p>';
        } else {
            cart.forEach(item => {
                total += item.price * item.quantity;
                const optionsText = Object.entries(item.options).map(([key, value]) => `${value}`).join(', ');
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center py-2 border-b';
                div.innerHTML = `
                    <div>
                        <p class="font-medium">${item.quantity} x ${item.name}</p>
                        <p class="text-xs text-gray-500">${optionsText}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-semibold">${formatCurrency(item.price * item.quantity)}</span>
                        <button onclick="removeFromCart(${item.cartItemId})" class="text-red-500 text-sm font-bold">X</button>
                    </div>
                `;
                cartItemsContainer.appendChild(div);
            });
        }
        cartTotal.textContent = formatCurrency(total);
    }
    
    function removeFromCart(cartItemId) {
        cart = cart.filter(item => item.cartItemId !== cartItemId);
        updateCart();
    }

    function toggleOptionsModal(show) {
        document.getElementById('options-modal').classList.toggle('hidden', !show);
    }

    function toggleCartModal(show) {
        document.getElementById('cart-modal').classList.toggle('hidden', !show);
        if(show) updateCart();
    }

    async function submitOrder() {
        if (!tableNumber) {
            alert("Số bàn không hợp lệ! Vui lòng quét lại mã QR.");
            return;
        }
        if(cart.length === 0) {
            alert("Vui lòng chọn món trước khi gửi đơn hàng.");
            return;
        }
        
        const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const orderData = {
            tableNumber: parseInt(tableNumber, 10),
            items: cart,
            totalAmount: totalAmount,
            note: document.getElementById('note').value,
        };

        try {
            const response = await fetch(`${API_URL}/api/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            if (!response.ok) {
                throw new Error('Gửi đơn hàng thất bại!');
            }

            // Reset cart and UI
            cart = [];
            updateCart();
            toggleCartModal(false);
            document.getElementById('note').value = '';
            
            // Show success notification
            const notification = document.getElementById('success-notification');
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);

        } catch (error) {
            console.error("Lỗi khi gửi đơn hàng:", error);
            alert("Đã có lỗi xảy ra. Vui lòng thử lại.");
        }
    }

    async function fetchMenu() {
        try {
            const response = await fetch(`${API_URL}api/menu`);
            if (!response.ok) throw new Error('Network response was not ok');
            menu = await response.json();
            renderCategories();
            renderMenu();
        } catch (error) {
            menuContainer.innerHTML = '<p class="text-red-500">Không thể tải thực đơn. Vui lòng thử lại.</p>';
            console.error('Fetch error:', error);
        }
    }

    window.onload = () => {
        if (!tableNumber) {
            document.body.innerHTML = '<div class="text-center p-8 text-red-600 font-bold">Lỗi: Không tìm thấy số bàn. Vui lòng quét lại mã QR.</div>';
            return;
        }
        document.querySelector('#table-number').textContent = tableNumber;
        fetchMenu();
        updateCart();
    };
</script>
</body>
</html>